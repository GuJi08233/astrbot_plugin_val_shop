# 无畏契约每日商店插件

一个用于查询无畏契约(Valorant)每日商店的AstrBot插件，支持智能配置识别和图片生成。

## 功能特性

- 🎯 **每日商店查询**：获取当日商店皮肤信息
- 🖼️ **图片生成**：自动生成精美的商店展示图片
- 🤖 **智能识别**：支持多种格式的配置信息解析
- 🔄 **@功能**：支持查询其他用户的商店
- 💾 **数据存储**：安全存储用户配置信息
- 🔧 **灵活配置**：支持调试模式和LLM服务商选择

## 安装方法

### 方式一：直接复制
```bash
# 1. 克隆或下载插件
git clone https://github.com/GuJi08033/astrbot_plugin_val_shop

# 2. 复制到AstrBot插件目录
cp -r astrbot_plugin_val_shop /path/to/astrbot/data/plugins/

# 3. 重启AstrBot
```

### 方式二：插件管理器
```bash
# 使用AstrBot插件管理器安装
astrbot plug install https://github.com/GuJi08033/astrbot_plugin_val_shop
```

## 使用方法

### 1. 绑定账户

在私聊中发送：
```
/瓦
userId:您的userId
tid:您的tid
```

**支持的输入格式**：
- **标准格式**：`userId:JA-xxxxxxxxxxxxx\ntid:您的tid字符串`
- **Cookie格式**：`clientType=9; uin=o105940478; appid=102061775; acctype=qc; openid=03A18A61C761D3C44890E2992BB868CE; access_token=551176E5981C1F5422A08C227D193827; userId=JA-ad62f8d0421946ae-ba7e0ce6ab418ba0; accountType=5; tid=B3C4B3BEA580ED2CD07880058D52F21D...`
- **自由文本**：直接粘贴包含配置信息的任意文本

**获取配置信息**：
1. **抓包工具**：使用Fiddler、Charles等工具抓取手机APP请求
2. **查找请求**：找到 `https://app.mval.qq.com/go/mlol_store/agame/user_store` 的POST请求
3. **提取Cookie**：从请求头中提取完整的Cookie字符串
4. **复制信息**：将包含userId和tid的Cookie信息复制给机器人

### 2. 查询商店

**查询自己的商店**：
```
/每日商店
```

**查询他人商店**：
```
/每日商店 @某人
```

## 配置选项

插件支持以下配置选项（在AstrBot管理界面中设置）：

### 基础配置
- **商店刷新间隔**：重新查询商店的时间间隔（秒），默认300秒
- **图片质量**：生成的图片质量级别（low/medium/high），默认medium
- **最大图片尺寸**：生成图片的最大宽度（像素），默认800px
- **字体文件**：用于显示文字的字体文件路径，默认./fontFamily.ttf

### 缓存设置
- **启用缓存**：是否缓存图片以提高响应速度，默认true
- **缓存时长**：图片缓存时间（分钟），默认30分钟

### 网络设置
- **重试次数**：网络请求失败时的重试次数，默认3次
- **超时时间**：网络请求超时时间（秒），默认15秒

### 高级配置
- **调试模式**：启用详细日志记录，默认false
- **LLM服务商**：用于智能解析配置的LLM服务商，留空使用默认服务商

## 技术实现

### 智能配置识别

插件采用两层解析策略：

1. **简单规则解析**：
   - 支持多种分隔符：分号、冒号、等号、中文冒号
   - 智能键名识别：支持各种键名变体
   - 格式兼容：支持Cookie格式、JSON格式、键值对格式

2. **LLM智能解析**：
   - 当简单解析失败时自动启用
   - 使用AstrBot配置的LLM服务商
   - 支持提取所有可能的配置字段

### 图片处理

- **多源下载**：自动下载背景图和商品图
- **智能合成**：将商品图片居中粘贴到背景图
- **文字渲染**：添加皮肤名称和价格信息
- **多图合并**：将所有商品图片垂直合并成长图
- **格式转换**：转换为base64格式发送

### 数据存储

- **SQLite数据库**：使用AstrBot内置的数据库
- **安全存储**：敏感信息加密存储
- **自动更新**：支持配置信息的更新和覆盖

## 故障排除

### 常见问题

**Q: 提示"您尚未绑定账户信息"**
A: 使用 `/瓦` 指令在私聊中绑定账户信息

**Q: 提示"配置过期或网络问题"**
A: 使用 `/瓦` 指令重新绑定最新的配置信息

**Q: 图片显示异常或文字乱码**
A: 检查插件目录下是否存在 `fontFamily.ttf` 字体文件

**Q: 无法识别配置信息**
A: 尝试以下方法：
   - 确保包含userId和tid字段
   - 检查格式是否正确
   - 尝试使用Cookie格式直接粘贴

**Q: @功能不工作**
A: 确保聊天平台支持@功能，部分平台可能不支持

### 调试模式

启用调试模式后，插件会输出详细的日志信息：
- 配置解析过程
- 网络请求详情
- API响应内容
- 图片处理步骤

## 开发信息

- **插件名称**：astrbot_plugin_val_shop
- **版本**：v1.0.0
- **作者**：GuJi08033
- **仓库**：https://github.com/GuJi08033/astrbot_plugin_val_shop
- **依赖**：无额外依赖（使用AstrBot内置库）

## 更新日志

### v1.0.0
- ✅ 实现基础商店查询功能
- ✅ 添加图片生成和合成功能
- ✅ 支持用户配置存储
- ✅ 实现@功能支持
- ✅ 添加智能配置识别
- ✅ 支持Cookie格式解析
- ✅ 添加调试模式选项
- ✅ 添加LLM服务商选择

## 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

## 贡献

欢迎提交Issue和Pull Request来改进插件功能！

## 支持

如果您觉得这个插件有用，请给个⭐支持一下！
