# 无畏契约每日商店插件

一个用于查询无畏契约(Valorant)每日商店的AstrBot插件，支持自动化扫码登录和图片生成。

## 功能特性

- 🎯 **每日商店查询**：获取当日商店皮肤信息
- 🖼️ **图片生成**：自动生成精美的商店展示图片
- 🔄 **自动化登录**：无头浏览器扫码登录，无需手动配置
- 📱 **二维码登录**：发送二维码图片，30秒内扫码即可绑定
- 🤖 **智能识别**：支持多种格式的配置信息解析
- 🔄 **@功能**：支持查询其他用户的商店
- 💾 **数据存储**：安全存储用户配置信息
- 🔧 **灵活配置**：支持调试模式和错误处理

## 安装方法

### 方式一：直接复制
```bash
# 1. 克隆或下载插件
git clone https://github.com/GuJi08033/astrbot_plugin_val_shop

# 2. 复制到AstrBot插件目录
cp -r astrbot_plugin_val_shop /path/to/astrbot/data/plugins/

# 3. 重启AstrBot
```

### 方式二：插件管理器
```bash
# 使用AstrBot插件管理器安装
astrbot plug install https://github.com/GuJi08033/astrbot_plugin_val_shop
```

## 使用方法

### 1. 自动化登录绑定（推荐）

在任意聊天中发送：
```
/瓦
```

**自动化流程**：
1. 插件启动无头浏览器访问QQ登录页面
2. 自动截取二维码图片并发送给您
3. 提示"请在30秒内扫码登录"
4. 使用手机QQ扫描二维码并确认登录
5. 插件自动检测登录状态并获取配置信息
6. 自动保存userId和tid到数据库
7. 发送登录成功确认消息

**优势**：
- ✅ 无需手动抓包或配置
- ✅ 无需了解技术细节
- ✅ 自动化流程，减少错误
- ✅ 安全可靠的后台处理

### 2. 查询商店

**查询自己的商店**：
```
/每日商店
```

**查询他人商店**：
```
/每日商店 @某人
```

## 配置选项

插件支持以下配置选项（在AstrBot管理界面中设置）：

### 基础配置
- **商店刷新间隔**：重新查询商店的时间间隔（秒），默认300秒
- **图片质量**：生成的图片质量级别（low/medium/high），默认medium
- **最大图片尺寸**：生成图片的最大宽度（像素），默认800px
- **字体文件**：用于显示文字的字体文件路径，默认./fontFamily.ttf

### 缓存设置
- **启用缓存**：是否缓存图片以提高响应速度，默认true
- **缓存时长**：图片缓存时间（分钟），默认30分钟

### 网络设置
- **重试次数**：网络请求失败时的重试次数，默认3次
- **超时时间**：网络请求超时时间（秒），默认15秒

### 高级配置
- **调试模式**：启用详细日志记录，默认false
- **登录超时**：二维码登录超时时间（秒），默认30秒

## 技术实现

### 自动化登录系统

插件集成了完整的无头浏览器登录流程：

1. **无头浏览器**：
   - 使用Playwright启动Chromium无头模式
   - 模拟移动设备User-Agent和视口
   - 完全后台运行，无需图形界面

2. **二维码处理**：
   - 自动等待二维码元素加载
   - 截取二维码图片并保存
   - 转换为base64格式发送

3. **状态监控**：
   - 实时监听登录API响应
   - 自动检测扫码、确认、成功状态
   - 异步事件驱动处理

4. **凭证获取**：
   - 自动解析登录成功URL参数
   - 调用mval API获取最终cookie
   - 提取userId和tid用于商店查询

### 智能配置识别（备用方案）

插件仍保留原有的智能配置识别功能：

1. **简单规则解析**：
   - 支持多种分隔符：分号、冒号、等号、中文冒号
   - 智能键名识别：支持各种键名变体
   - 格式兼容：支持Cookie格式、JSON格式、键值对格式

2. **LLM智能解析**：
   - 当简单解析失败时自动启用
   - 使用AstrBot配置的LLM服务商
   - 支持提取所有可能的配置字段

### 图片处理

- **多源下载**：自动下载背景图和商品图
- **智能合成**：将商品图片居中粘贴到背景图
- **文字渲染**：添加皮肤名称和价格信息
- **多图合并**：将所有商品图片垂直合并成长图
- **格式转换**：转换为base64格式发送

### 数据存储

- **SQLite数据库**：使用AstrBot内置的数据库
- **安全存储**：敏感信息加密存储
- **自动更新**：支持配置信息的更新和覆盖

## 故障排除

### 常见问题

**Q: 提示"您尚未绑定账户信息"**
A: 使用 `/瓦` 指令进行自动化扫码登录绑定

**Q: 二维码登录失败**
A: 尝试以下方法：
   - 确保在30秒内扫码
   - 检查网络连接是否正常
   - 重新发送 `/瓦` 命令

**Q: 提示"配置过期或网络问题"**
A: 使用 `/瓦` 指令重新进行自动化登录

**Q: 图片显示异常或文字乱码**
A: 检查插件目录下是否存在 `fontFamily.ttf` 字体文件

**Q: @功能不工作**
A: 确保聊天平台支持@功能，部分平台可能不支持

### 调试模式

启用调试模式后，插件会输出详细的日志信息：
- 无头浏览器启动过程
- 二维码生成和截图
- 登录状态监控
- API请求详情
- 图片处理步骤

## 开发信息

- **插件名称**：astrbot_plugin_val_shop
- **版本**：v2.0.0
- **作者**：GuJi08033
- **仓库**：https://github.com/GuJi08033/astrbot_plugin_val_shop
- **依赖**：playwright>=1.56.0, requests>=2.32.5, pillow>=12.0.0

## 更新日志

### v2.0.0
- ✅ 集成无头浏览器自动化登录
- ✅ 添加二维码截图和发送功能
- ✅ 实现30秒扫码登录流程
- ✅ 自动获取userId和tid配置
- ✅ 简化用户操作流程
- ✅ 保留原有商店查询功能
- ✅ 优化依赖管理

### v1.0.0
- ✅ 实现基础商店查询功能
- ✅ 添加图片生成和合成功能
- ✅ 支持用户配置存储
- ✅ 实现@功能支持
- ✅ 添加智能配置识别
- ✅ 支持Cookie格式解析
- ✅ 添加调试模式选项
- ✅ 添加LLM服务商选择

## 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

## 贡献

欢迎提交Issue和Pull Request来改进插件功能！

## 支持

如果您觉得这个插件有用，请给个⭐支持一下！
